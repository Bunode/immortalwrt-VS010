name: Build VS010 Firmware

on:
  workflow_dispatch: # 允许手动点击按钮启动

jobs:
  build:
    runs-on: ubuntu-22.04 # 使用稳定的 22.04 环境
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Setup Compilation Environment
        run: |
          sudo apt update
          sudo apt install -y build-essential flex gawk gettext git libncurses5-dev libssl-dev python3 python3-setuptools swig unzip zlib1g-dev file wget
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Generate .config
        run: |
          # 1. 基础目标机型
          echo "CONFIG_TARGET_qualcommax=y" > .config
          echo "CONFIG_TARGET_qualcommax_ipq50xx=y" >> .config
          echo "CONFIG_TARGET_qualcommax_ipq50xx_DEVICE_cucc_vs010=y" >> .config

          # 2. 核心网络驱动 (VS010 联网的关键)
          echo "CONFIG_PACKAGE_kmod-qca-nss-dp=y" >> .config
          echo "CONFIG_PACKAGE_kmod-qca-nss-drv=y" >> .config
          echo "CONFIG_PACKAGE_kmod-qca-nss-ecm=y" >> .config
          echo "CONFIG_PACKAGE_kmod-qca-nss-ecm-standard=y" >> .config
          
          # 3. 闭源 QSDK WiFi 驱动 (注意：删除之前的 ath11k 开源固件，改用 QSDK 方案)
          echo "CONFIG_PACKAGE_kmod-qca-wifi-qsdk=y" >> .config
          echo "CONFIG_PACKAGE_kmod-qca-wifi-qsdk-db=y" >> .config
          
          # 4. LuCI 与 基础 UI
          echo "CONFIG_PACKAGE_luci=y" >> .config
          echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config
          
          # 5. IPTV 与 工具
          echo "CONFIG_PACKAGE_luci-app-udpxy=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-wol=y" >> .config

          # 6. 统计图表 (建议暂时精简，防止因依赖过多导致编译失败)
          echo "CONFIG_PACKAGE_luci-app-statistics=y" >> .config
          echo "CONFIG_PACKAGE_collectd-mod-cpu=y" >> .config
          echo "CONFIG_PACKAGE_collectd-mod-interface=y" >> .config
          echo "CONFIG_PACKAGE_collectd-mod-load=y" >> .config

          # 7. 必须执行：强制补全所有缺失的底层依赖
          make defconfig

      - name: Make Download
        run: make download -j8

      - name: Compile Firmware
        run: make -j$(nproc) || make -j1 V=s

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VS010-ImmortalWrt-Firmware
          path: bin/targets/qualcommax/ipq50xx/*.bin
