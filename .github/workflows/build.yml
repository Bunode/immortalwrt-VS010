name: Build VS010 Firmware

on:
  workflow_dispatch: # 允许手动点击按钮启动

jobs:
  build:
    runs-on: ubuntu-22.04 # 使用稳定的 22.04 环境
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Setup Compilation Environment
        run: |
          sudo apt update
          sudo apt install -y build-essential flex gawk gettext git libncurses5-dev libssl-dev python3 python3-setuptools swig unzip zlib1g-dev file wget
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Generate .config
        run: |
          # 1. 基础目标机型 (由你定义的 VS010)
          echo "CONFIG_TARGET_qualcommax=y" > .config
          echo "CONFIG_TARGET_qualcommax_ipq50xx=y" >> .config
          echo "CONFIG_TARGET_qualcommax_ipq50xx_DEVICE_cucc_vs010=y" >> .config
          
          # 2. NSS 硬件转发加速 (高性能核心)
          echo "CONFIG_PACKAGE_kmod-qca-nss-drv=y" >> .config
          echo "CONFIG_PACKAGE_kmod-qca-nss-ecm=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
          
          # 3. 闭源 QSDK WiFi 驱动 (高性能无线)
          echo "CONFIG_PACKAGE_kmod-qca-wifi-qsdk=y" >> .config
          echo "CONFIG_PACKAGE_ath11k-firmware-ipq5018=y" >> .config
          
          # 4. LuCI 界面与主题
          echo "CONFIG_PACKAGE_luci=y" >> .config
          echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config
          
          # 5. 新增功能插件 (IPTV与唤醒)
          echo "CONFIG_PACKAGE_luci-app-udpxy=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-wol=y" >> .config
          
          # 统计图表及核心依赖
          echo "CONFIG_PACKAGE_luci-app-statistics=y" >> .config
          echo "CONFIG_PACKAGE_collectd=y" >> .config
          echo "CONFIG_PACKAGE_collectd-mod-rrdtool=y" >> .config
          echo "CONFIG_PACKAGE_collectd-mod-cpu=y" >> .config
          echo "CONFIG_PACKAGE_collectd-mod-cpufreq=y" >> .config
          echo "CONFIG_PACKAGE_collectd-mod-sensors=y" >> .config
          echo "CONFIG_PACKAGE_collectd-mod-thermal=y" >> .config
          echo "CONFIG_PACKAGE_collectd-mod-interface=y" >> .config
          echo "CONFIG_PACKAGE_collectd-mod-load=y" >> .config
          echo "CONFIG_PACKAGE_collectd-mod-network=y" >> .config

          # 内核监控支持
          echo "CONFIG_PACKAGE_kmod-hwmon-core=y" >> .config
          echo "CONFIG_PACKAGE_kmod-cpufreq-stats=y" >> .config
          
          # 自动补全依赖并应用配置
          make defconfig

      - name: Make Download
        run: make download -j8

      - name: Compile Firmware
        run: make -j$(nproc) || make -j1 V=s

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VS010-ImmortalWrt-Firmware
          path: bin/targets/qualcommax/ipq50xx/*.bin
